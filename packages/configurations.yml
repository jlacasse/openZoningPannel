# Configuration I2C
i2c:
  scl: D1
  sda: D2
  scan: false
  id: bus_a

# Enable Home Assistant API
api:
  encryption:
    key: !secret geo_api_key

# Over-The-Air updates
ota:
  - platform: esphome
    password: !secret geo_ota_password

# Configuration WiFi
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  min_auth_mode: WPA2
  power_save_mode: none  # Disable WiFi power saving to prevent disconnections
  fast_connect: true     # Skip scanning, connect directly to known SSID

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Geothermie Fallback Hotspot"
    password: !secret geo_fallback_password

# Configuration des expanders MCP23017
mcp23017:
  - id: 'mcp23017_0x20'
    address: 0x20
  - id: 'mcp23017_0x21'
    address: 0x21
  - id: 'mcp23017_0x22'
    address: 0x22

# NOTE: Les paramètres min_cycle_time, stage2_escalation_delay et auto_mode
# sont compilés dans le composant open_zoning (component.yml).
# Les entités ci-dessous permettent de les ajuster à chaud depuis Home Assistant.

number:
  - platform: template
    name: "Geo_min_cycle_time"
    id: geo_min_cycle_time
    unit_of_measurement: "s"
    icon: "mdi:timer-outline"
    entity_category: config
    min_value: 60
    max_value: 900
    step: 30
    initial_value: 480
    optimistic: true
    set_action:
      - lambda: |-
          id(open_zoning_ctrl).set_min_cycle_time((uint32_t)(x * 1000));

switch:
  - platform: template
    name: "Geo_auto_mode_switch"
    id: geo_auto_mode_switch
    icon: "mdi:auto-fix"
    entity_category: config
    optimistic: true
    turn_on_action:
      - lambda: |-
          id(open_zoning_ctrl).set_auto_mode(true);
    turn_off_action:
      - lambda: |-
          id(open_zoning_ctrl).set_auto_mode(false);
